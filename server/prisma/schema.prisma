// server/prisma/schema.prisma
generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id              Int       @id @default(autoincrement())

  // ğŸ”‘ Cihaz kimliÄŸi (anon login)
  deviceId        String    @unique

  // ğŸŒ Onboarding / ayarlar
  language        String?   // Ã¶rn: "tr", "en", "de"

  // ğŸ‘¤ Profil alanlarÄ± (backend profil modeli)
  fullName        String?   // "KazÄ±m Arslan"
  handle          String?   @unique // "kazimarslan" (UI'da @ ile gÃ¶sterilir)
  bio             String?
  website         String?
  avatarUri       String?

  email           String?   @unique
  phone           String?   @unique
  isPhoneVerified Boolean   @default(false)

  // ğŸ” Åifre hash (email/phone login iÃ§in)
  passwordHash    String?

  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  // ğŸ”— Ä°liÅŸkiler
  tasks           Task[]
  posts           Post[]

  // âœ… Like/Comment iliÅŸkileri
  likes           Like[]
  comments        Comment[]

  // ğŸ‘¥ Focus AÄŸÄ± iliÅŸkileri
  sentFriendRequests     FriendRequest[] @relation("FriendRequestsSent")
  receivedFriendRequests FriendRequest[] @relation("FriendRequestsReceived")
}

model Task {
  id               Int       @id @default(autoincrement())

  // ğŸ”— Sahip kullanÄ±cÄ±
  user             User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId           Int

  // Ana bilgiler
  title            String
  description      String?
  category         String    @default("Genel")   // TaskCategory
  priority         String    @default("Orta")    // TaskPriority
  origin           String    @default("self")    // 'self' | 'given' | 'legacy'
  templateId       String?                       // TASK_TEMPLATES id

  // Durum
  status           String    @default("pending") // 'pending' | 'done' | 'skipped' | 'expired'
  done             Boolean   @default(false)

  // Zaman alanlarÄ±
  ts               DateTime  @default(now())     // oluÅŸturulma
  dueDate          DateTime?
  timeOfDay        String?                       // 'sabah' | 'Ã¶ÄŸlen' | 'akÅŸam' | 'Ã¶zel'

  // Tekrar / planlama
  repeatType       String    @default("none")    // TaskRepeatType
  repeatDaysOfWeek String?                       // JSON string: Ã¶rn "[1,3,5]"
  repeatStartDate  DateTime?
  repeatEndDate    DateTime?

  // Tamamlanma & edit bilgisi
  completedAt      DateTime?
  lastEditAt       DateTime?
  editsTodayCount  Int       @default(0)

  // Grup gÃ¶revleri / Pro
  isGroupTask       Boolean   @default(false)
  assignedByUserId  Int?
  assignedToUserIds String?                     // JSON string: Ã¶rn '["u1","u2"]'
  requiresPro       Boolean   @default(false)

  // Audit
  createdAt        DateTime  @default(now())
  updatedAt        DateTime  @updatedAt
}

model Post {
  id           Int       @id @default(autoincrement())

  // Kart bilgileri
  taskTitle    String?
  note         String?
  author       String?    // ÅŸimdilik string; ileride User ile tam baÄŸlarÄ±z

  // Mod ve hedefler
  isFreePost   Boolean   @default(true)
  shareTargets String?   // JSON string: ['Instagram','X', ...]

  // Video bilgisi (ÅŸimdilik sadece URI metni)
  videoUri     String?

  // âœ… NEW: Repost / Archive / Share meta (server/src/index.ts ile uyum)
  // - repost endpointi "reshareCount increment" yapÄ±yor
  // - archive endpointi "archived" set ediyor
  // - shared endpointi "lastSharedAt (number)" set ediyor
  // - lastSharedTargets dizi olarak saklanÄ±r (Postgres array)
  reshareCount     Int       @default(0)
  archived         Boolean   @default(false)
  lastSharedAt     BigInt?
  lastSharedTargets String[] @default([])

  // Zaman
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt

  // ğŸ”— Ä°steÄŸe baÄŸlÄ± User iliÅŸkisi
  userId       Int?
  user         User?     @relation(fields: [userId], references: [id])

  // âœ… Like/Comment iliÅŸkileri
  likes        Like[]
  comments     Comment[]

  @@index([createdAt])
  @@index([userId])
}

model Like {
  id        Int      @id @default(autoincrement())

  post      Post     @relation(fields: [postId], references: [id], onDelete: Cascade)
  postId    Int

  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId    Int

  createdAt DateTime @default(now())

  @@unique([postId, userId], name: "uniq_like_post_user")
  @@index([postId])
  @@index([userId])
}

model Comment {
  id        Int      @id @default(autoincrement())

  post      Post     @relation(fields: [postId], references: [id], onDelete: Cascade)
  postId    Int

  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId    Int

  text      String

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([postId, createdAt])
  @@index([userId, createdAt])
}

model FriendRequest {
  id         Int      @id @default(autoincrement())

  fromUser   User     @relation("FriendRequestsSent", fields: [fromUserId], references: [id], onDelete: Cascade)
  fromUserId Int

  toUser     User     @relation("FriendRequestsReceived", fields: [toUserId], references: [id], onDelete: Cascade)
  toUserId   Int

  status     String   @default("pending") // 'pending' | 'accepted' | 'declined' | 'cancelled'

  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  @@index([toUserId, status])
  @@index([fromUserId, status])
  @@unique([fromUserId, toUserId, status], name: "uniq_active_request")
}

model Friendship {
  id        Int      @id @default(autoincrement())

  user1Id   Int
  user2Id   Int

  createdAt DateTime @default(now())

  @@unique([user1Id, user2Id], name: "uniq_friendship_pair")
  @@index([user1Id])
  @@index([user2Id])
}
