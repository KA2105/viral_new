// server/prisma/schema.prisma
generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id              Int       @id @default(autoincrement())

  // üîë Cihaz kimliƒüi (anon login)
  deviceId        String    @unique

  // üåç Onboarding / ayarlar
  language        String?   // √∂rn: "tr", "en", "de"

  // üë§ Profil alanlarƒ± (backend profil modeli)
  fullName        String?   // "Kazƒ±m Arslan"
  handle          String?   @unique // "kazimarslan" (UI'da @ ile g√∂sterilir)
  bio             String?
  website         String?
  avatarUri       String?

  email           String?   @unique
  phone           String?   @unique
  isPhoneVerified Boolean   @default(false)

  // üîê ≈ûifre hash (email/phone login i√ßin)
  passwordHash    String?

  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  // üîó ƒ∞li≈ükiler
  tasks           Task[]
  posts           Post[]

  // üë• Focus Aƒüƒ± ili≈ükileri
  sentFriendRequests     FriendRequest[] @relation("FriendRequestsSent")
  receivedFriendRequests FriendRequest[] @relation("FriendRequestsReceived")
}

model Task {
  id               Int       @id @default(autoincrement())

  // üîó Sahip kullanƒ±cƒ±
  user             User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId           Int

  // Ana bilgiler
  title            String
  description      String?
  category         String    @default("Genel")   // TaskCategory
  priority         String    @default("Orta")    // TaskPriority
  origin           String    @default("self")    // 'self' | 'given' | 'legacy'
  templateId       String?                       // TASK_TEMPLATES id

  // Durum
  status           String    @default("pending") // 'pending' | 'done' | 'skipped' | 'expired'
  done             Boolean   @default(false)

  // Zaman alanlarƒ±
  ts               DateTime  @default(now())     // olu≈üturulma
  dueDate          DateTime?
  timeOfDay        String?                       // 'sabah' | '√∂ƒülen' | 'ak≈üam' | '√∂zel'

  // Tekrar / planlama
  repeatType       String    @default("none")    // TaskRepeatType
  repeatDaysOfWeek String?                       // JSON string: √∂rn "[1,3,5]"
  repeatStartDate  DateTime?
  repeatEndDate    DateTime?

  // Tamamlanma & edit bilgisi
  completedAt      DateTime?
  lastEditAt       DateTime?
  editsTodayCount  Int       @default(0)

  // Grup g√∂revleri / Pro
  isGroupTask       Boolean   @default(false)
  assignedByUserId  Int?
  assignedToUserIds String?                     // JSON string: √∂rn '["u1","u2"]'
  requiresPro       Boolean   @default(false)

  // Audit
  createdAt        DateTime  @default(now())
  updatedAt        DateTime  @updatedAt
}

model Post {
  id           Int       @id @default(autoincrement())

  // Kart bilgileri
  taskTitle    String?
  note         String?
  author       String?    // ≈üimdilik string; ileride User ile tam baƒülarƒ±z

  // Mod ve hedefler
  isFreePost   Boolean   @default(true)
  shareTargets String?   // JSON string: ['Instagram','X', ...]

  // Video bilgisi (≈üimdilik sadece URI metni)
  videoUri     String?

  // Zaman
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt

  // üîó ƒ∞steƒüe baƒülƒ± User ili≈ükisi
  userId       Int?
  user         User?     @relation(fields: [userId], references: [id])
}

// ‚úÖ Arkada≈ü istekleri
model FriendRequest {
  id         Int      @id @default(autoincrement())

  fromUser   User     @relation("FriendRequestsSent", fields: [fromUserId], references: [id], onDelete: Cascade)
  fromUserId Int

  toUser     User     @relation("FriendRequestsReceived", fields: [toUserId], references: [id], onDelete: Cascade)
  toUserId   Int

  status     String   @default("pending") // 'pending' | 'accepted' | 'declined' | 'cancelled'

  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  @@index([toUserId, status])
  @@index([fromUserId, status])
  @@unique([fromUserId, toUserId, status], name: "uniq_active_request")
}

// ‚úÖ Arkada≈ülƒ±k (kanonik √ßift: k√º√ß√ºk id -> b√ºy√ºk id)
model Friendship {
  id        Int      @id @default(autoincrement())

  user1Id   Int
  user2Id   Int

  createdAt DateTime @default(now())

  @@unique([user1Id, user2Id], name: "uniq_friendship_pair")
  @@index([user1Id])
  @@index([user2Id])
}
